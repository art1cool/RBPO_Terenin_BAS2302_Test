on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: maven:3.9-eclipse-temurin-21

    env:
      SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
      SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    services:
      postgres:
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        image: postgres:15
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build
        run: mvn clean package -DskipTests

      - name: Create application.yml
        run: |
          cat > src/main/resources/application.yml << EOF
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/postgres
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          lob:
            non_contextual_creation: true
  sql:
    init:
      mode: always

server:
  port: 8080
  ssl:
    enabled: false

jwt:
  secret: ${JWT_SECRET}
  accessExpiration: 900000
  refreshExpiration: 604800000
  EOF

- name: Install PostgreSQL client
  run: apt-get update && apt-get install -y postgresql-client

- name: Wait for PostgreSQL
  run: |
    for i in {1..30}; do
      if PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "SELECT 1;" >/dev/null 2>&1; then
        echo "PostgreSQL is ready!"
        break
      fi
      echo "Waiting for PostgreSQL... ($i/30)"
      sleep 2
    done

- name: Check database connection
  run: |
    echo "Testing PostgreSQL connection..."
    PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "SELECT version();"
    PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "\l"

- name: Run tests
  run: mvn test

- name: Artifacts
  uses: actions/upload-artifact@v4
  with:
    name: app-jar
    path: ./target/*.jar