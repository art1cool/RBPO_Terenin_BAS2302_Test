#on:
#  push:
#    branches:
#      - master
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    container:
#      image: maven:3.9-eclipse-temurin-21
#    env:
#      SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
#      SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
#      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
#      JWT_SECRET: ${{ secrets.JWT_SECRET }}
#    services:
#      postgres:
#        env:
#          POSTGRES_DB: postgres
#          POSTGRES_USER: postgres
#          POSTGRES_PASSWORD: postgres
#        image: postgres:15
#        options: >-
#          --health-cmd pg_isready
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5
#        ports:
#          - 5432:5432
#    steps:
#      - run: |
#          echo ${{ secrets.SQL_USERNAME }}
#          echo ${{ secrets.SQL_PASSWORD }}
#          echo ${{ secrets.KEYSTORE_PASSWORD }}
#          echo ${{ secrets.JWT_SECRET }}
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Build
#        run: mvn clean package -DskipTests
#
#      - name: Test
#        run: |
#          cat > src/main/resources/application.yml << EOF
#          spring.application.name=DemoApplication
#          spring.datasource.url=jdbc:postgresql://localhost:5432/postgres
#          spring.datasource.username=${SQL_USERNAME}
#          spring.datasource.password=${SQL_PASSWORD}
#          spring.datasource.driver-class-name=org.postgresql.Driver
#          spring.jpa.hibernate.ddl-auto=none
#          spring.jpa.show-sql=true
#          spring.jpa.properties.hibernate.format_sql=true
#          spring.sql.init.platform=postgresql
#          server.port=8080
#          logging.level.org.springframework.security=DEBUG
#          logging.level.org.springframework.web=DEBUG
#          jwt.secret=${{ secrets.JWT_SECRET }}
#          jwt.accessExpiration=900000
#          jwt.refreshExpiration=604800000
#          server.ssl.enabled=false
#          server.ssl.key-store=classpath:server_cert1BIB23342.jks
#          server.ssl.key-store-type=JKS
#          server.ssl.key-store-password=${{ secrets.KEYSTORE_PASSWORD }}
#          server.ssl.key-alias=server_cert1BIB23342
#          EOF
#      - run: apt-get update && apt-get install -y postgresql-client
#      - run: sleep 25
#      - run: mvn test
#
#      - name: Artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: app-jar
#          path: ./target/*.jar

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: maven:3.9-eclipse-temurin-21
    env:
      SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
      SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    services:
      postgres:
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: ${{ secrets.SQL_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.SQL_PASSWORD }}
        image: postgres:15
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug PostgreSQL driver
        run: |
          echo "Checking PostgreSQL driver in pom.xml..."
          grep -i "postgresql" pom.xml || echo "PostgreSQL dependency not found in pom.xml"
          echo "Maven dependencies:"
          mvn dependency:tree | grep -i postgres || echo "No PostgreSQL in dependency tree"

      - name: Build
        run: mvn clean compile

      - name: Create application.yml
        run: |
          cat > src/main/resources/application.yml << 'EOF'
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/postgres
    username: ${SQL_USERNAME}
    password: ${SQL_PASSWORD}
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    database: postgresql
  sql:
    init:
      mode: always
      platform: postgresql

server:
  port: 8080
  ssl:
    enabled: false

jwt:
  secret: ${JWT_SECRET}
  accessExpiration: 900000
  refreshExpiration: 604800000

logging:
  level:
    root: INFO
    org.springframework: INFO
    org.hibernate: INFO
  EOF

- name: Install PostgreSQL client
  run: apt-get update && apt-get install -y postgresql-client

- name: Wait for PostgreSQL
  run: |
    for i in {1..30}; do
      if PGPASSWORD=${{ secrets.SQL_PASSWORD }} psql -h localhost -U ${{ secrets.SQL_USERNAME }} -d postgres -c "SELECT 1;" >/dev/null 2>&1; then
        echo "PostgreSQL is ready!"
        break
      fi
      echo "Waiting for PostgreSQL... ($i/30)"
      sleep 2
    done

- name: Test database connection
  run: |
    PGPASSWORD=${{ secrets.SQL_PASSWORD }} psql -h localhost -U ${{ secrets.SQL_USERNAME }} -d postgres -c "SELECT version();"

- name: Run tests
  run: mvn test

- name: Package
  run: mvn package -DskipTests

- name: Artifacts
  uses: actions/upload-artifact@v4
  with:
    name: app-jar
    path: ./target/*.jar